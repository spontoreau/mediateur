name: "Release"

on:
  push:
    branches:
      - release/*

jobs:
  call-shared-workflow:
    uses: ./.github/workflows/shared-workflow.yml

  package-version:
    needs: call-shared-workflow
    runs-on: ubuntu-latest
    outputs:
      packageVersion: ${{ steps.package_version.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: "npm"
      - name: Set package version
        id: package_version
        run: |
          GIT_BRANCH=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
          BRANCH_VERSION=$(printf '%s\n' ${GIT_BRANCH//release\//})
          TAG_VERSION=$(git tag --list | sort -V | tail -n1)
          VERSION="$(export BRANCH_VERSION="${BRANCH_VERSION}" && TAG_VERSION="${TAG_VERSION}" && node .github/scripts/getVersion.js)"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

  publish-beta:
    needs: package-version
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.package-version.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: "npm"
          registry-url: 'https://registry.npmjs.org'

      - uses: actions/download-artifact@v3
        with:
          name: mediateur-package
      #- name: Publish beta version
